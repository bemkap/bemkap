d=: 10 <.@:>:@^. ]
ext=: ,@:+((01+i.9)*/~10^d)
next=: 4 : 0
 x(]#~(2>:10|(<.@%)&(10^<:d{.y))@:*)y
)
fin=: (1-+./@:((2*./@:>:10#.inv*)"0))

f=: ([ ext@:]^:fin ~.@:next)^:_&(>:i.9)
g=: ((]{~1:i.~2*./"1@:>:10#.inv*)(/:~)@:x:@:f)